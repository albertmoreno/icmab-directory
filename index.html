<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal de Informaci√≥n - ICMAB</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Directori del personal de l'Institut de Ci√®ncia de Materials de Barcelona">
    <meta name="theme-color" content="#0345bf">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ICMAB Directori">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- PWA Icons -->
    <link rel="icon" href="https://media.icmab.es/logos/icmab/faviconblue.png" sizes="any">
    <link rel="icon" type="image/svg+xml" href="https://media.icmab.es/logos/icmab/faviconblue.svg">
    <link rel="apple-touch-icon" href="https://media.icmab.es/logos/icmab/faviconblue.svg">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Fuente Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header class="text-center py-4">
            <div class="container">
                <div class="logo-section mb-3">
                    <img src="https://media.icmab.es/logos/icmab/BANNER-WEB-icmabcsic-2025.png" alt="Logo ICMAB"
                        height="80" class="mb-2 img-fluid logo-desktop">
                    <img src="https://media.icmab.es/logos/icmab/icmab-ochoa-color.svg" alt="Logo ICMAB" height="60"
                        class="mb-2 img-fluid logo-tablet">
                    <div class="portal-info">
                        <h4 class="mb-1 text-dark">Directori del personal</h4>
                        <p class="text-muted mb-0">Institut de Ci√®ncia de Materials de Barcelona</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenido principal -->
        <main>
            <!-- Pesta√±as de navegaci√≥n -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation" v-for="tab in tabs" :key="tab.id">
                    <button class="nav-link" :class="{ active: activeTab === tab.id }" @click="activeTab = tab.id"
                        type="button" role="tab">
                        <i :class="tab.icon"></i> {{ tab.title }}
                    </button>
                </li>
            </ul>

            <!-- Contenido de las pesta√±as -->
            <div class="tab-content">
                <!-- Pesta√±a Directorio -->
                <div class="tab-pane fade" :class="{ 'show active': activeTab === 'directorio' }" role="tabpanel">
                    <div class="mt-4">
                        <h2><i class="bi bi-people"></i> Directori de personal</h2>

                        <!-- Estad√≠sticas -->
                        <div class="stats" v-if="personal.length > 0">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <strong>{{ personal.length }}</strong><br>
                                    <small class="text-muted">Total</small>
                                </div>
                                <div class="col-md-4">
                                    <strong>{{ filteredPersonal.length }}</strong><br>
                                    <small class="text-muted">Mostrats</small>
                                </div>
                                <div class="col-md-4">
                                    <strong>{{ uniqueDepartments.length }}</strong><br>
                                    <small class="text-muted">Departaments</small>
                                </div>
                            </div>
                        </div>

                        <!-- Buscador -->
                        <div class="buscador">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" v-model="searchQuery"
                                            placeholder="Buscar per nom, cognom, cognom2, email o usuari...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" v-model="selectedDepartment">
                                        <option value="">Tots els departaments</option>
                                        <option v-for="dept in uniqueDepartments" :key="dept" :value="dept">
                                            {{ dept }}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-primary"
                                            :class="{ active: viewMode === 'grid' }" @click="viewMode = 'grid'">
                                            <i class="bi bi-grid"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary"
                                            :class="{ active: viewMode === 'list' }" @click="viewMode = 'list'">
                                            <i class="bi bi-list"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de personal -->
                        <div v-if="loading" class="loading">
                            <i class="bi bi-arrow-clockwise spin"></i> Carregant personal...
                        </div>

                        <div v-else-if="error" class="error">
                            Error: {{ error }}
                        </div>

                        <div v-else-if="filteredPersonal.length === 0" class="loading">
                            No s'ha trobat cap resultat
                        </div>

                        <div v-else>
                            <!-- Vista de grilla -->
                            <div v-if="viewMode === 'grid'" class="row">
                                <div v-for="person in filteredPersonal" :key="person.id"
                                    class="col-lg-6 col-md-12 mb-3">
                                    <div class="card persona h-100">
                                        <div class="card-body">
                                            <div class="photo-section">
                                                <img :src="`https://media.icmab.es/staff/people/${person.username}.jpg`"
                                                    :alt="person.cognom" :data-person-id="person.id"
                                                    @error="(e) => handleImageError(e, person)" class="mb-3">
                                            </div>
                                            <div class="info-section">
                                                <h5 class="card-title">
                                                    <span
                                                        v-html="highlightSearch(person.cognom + ' ' + (person.cognom2 || '') + ', ' + person.nom)"></span>
                                                </h5>
                                                <div v-if="person.department_name" class="department-name">
                                                    {{ person.department_name }}
                                                </div>
                                                <div class="contact-info">
                                                    <div v-if="person.telefon1 || person.telefon2" class="contact-item">
                                                        <i class="bi bi-telephone"></i>
                                                        <template v-if="person.telefon2 && person.telefon1">
                                                            <a :href="`tel:${person.telefon2}`">{{ person.telefon2
                                                                }}</a> | Ext. {{ person.telefon1 }}
                                                        </template>
                                                        <template v-else-if="person.telefon2">
                                                            <a :href="`tel:${person.telefon2}`">{{ person.telefon2
                                                                }}</a>
                                                        </template>
                                                        <template v-else>
                                                            Ext. {{ person.telefon1 }}
                                                        </template>
                                                    </div>
                                                    <div v-if="person.email" class="contact-item">
                                                        <i class="bi bi-envelope"></i>
                                                        <a :href="`mailto:${person.email}`">{{ person.email }}</a>
                                                    </div>
                                                    <div v-if="hasValidContactValue(person.despatx) || hasValidContactValue(person.bustia)"
                                                        class="contact-item">
                                                        <template
                                                            v-if="hasValidContactValue(person.despatx) && hasValidContactValue(person.bustia)">
                                                            <i class="bi bi-building"></i>{{
                                                            formatContactValue(person.despatx) }}
                                                            | <i class="bi bi-mailbox ms-1"></i>{{
                                                            formatContactValue(person.bustia) }}
                                                        </template>
                                                        <template v-else-if="hasValidContactValue(person.despatx)">
                                                            <i class="bi bi-building"></i>{{
                                                            formatContactValue(person.despatx) }}
                                                        </template>
                                                        <template v-else>
                                                            <i class="bi bi-mailbox"></i>{{
                                                            formatContactValue(person.bustia) }}
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vista de lista -->
                            <div v-else class="list-group">
                                <div v-for="person in filteredPersonal" :key="person.id"
                                    class="list-group-item list-group-item-action">
                                    <div class="d-flex align-items-center">
                                        <img :src="`https://media.icmab.es/staff/people/${person.username}.jpg`"
                                            :alt="person.cognom" :data-person-id="person.id"
                                            @error="(e) => handleImageError(e, person)" class="rounded-circle me-3"
                                            style="width: 50px; height: 50px; object-fit: cover;">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <span
                                                    v-html="highlightSearch(person.cognom + ' ' + (person.cognom2 || '') + ', ' + person.nom)"></span>
                                            </h6>
                                            <small v-if="person.department_name" class="text-muted">
                                                {{ person.department_name }}
                                            </small>
                                            <div class="contact-info mt-2">
                                                <div v-if="person.telefon1 || person.telefon2" class="contact-item">
                                                    <i class="bi bi-telephone"></i>
                                                    <template v-if="person.telefon2 && person.telefon1">
                                                        <a :href="`tel:${person.telefon2}`">{{ person.telefon2 }}</a> |
                                                        Ext. {{ person.telefon1 }}
                                                    </template>
                                                    <template v-else-if="person.telefon2">
                                                        <a :href="`tel:${person.telefon2}`">{{ person.telefon2 }}</a>
                                                    </template>
                                                    <template v-else>
                                                        √áExt. {{ person.telefon1 }}
                                                    </template>
                                                </div>
                                                <div v-if="person.email" class="contact-item">
                                                    <i class="bi bi-envelope"></i> {{ person.email }}
                                                </div>
                                                <div v-if="hasValidContactValue(person.despatx) || hasValidContactValue(person.bustia)"
                                                    class="contact-item">
                                                    <template
                                                        v-if="hasValidContactValue(person.despatx) && hasValidContactValue(person.bustia)">
                                                        <i class="bi bi-building"></i>{{
                                                        formatContactValue(person.despatx) }}
                                                        | <span class="ms-1"><i class="bi bi-mailbox"></i>{{
                                                            formatContactValue(person.bustia) }}</span>
                                                    </template>
                                                    <template v-else-if="hasValidContactValue(person.despatx)">
                                                        <i class="bi bi-building"></i>{{
                                                        formatContactValue(person.despatx) }}
                                                    </template>
                                                    <template v-else>
                                                        <i class="bi bi-mailbox"></i>{{
                                                        formatContactValue(person.bustia) }}
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Emergencia -->
                <div class="tab-pane fade" :class="{ 'show active': activeTab === 'emergencia' }" role="tabpanel">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="page-flex">
                                <div class="col-4">
                                    <h2 class="senyalizacion-title">Se√±alizaci√≥n</h2>

                                    <div class="signage-list">
                                        <div class="sign-item">
                                            <div class="sign-icon">Q</div>
                                            <div>
                                                <div><b>Laboratorios qu√≠micos</b></div>
                                                <div>
                                                    Presencia de productos de diferente nivel de toxicidad.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sign-item">
                                            <div class="sign-icon">B</div>
                                            <div>
                                                <div><b>Laboratorio biol√≥gico nivel 2</b></div>
                                                <div>
                                                    Zona de acceso controlado.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sign-item">
                                            <div class="sign-icon">R</div>
                                            <div>
                                                <div><b>Instalaci√≥n radiactiva</b></div>
                                                <div>
                                                    Zona de acceso restringido.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sign-item">
                                            <div class="sign-icon">M</div>
                                            <div>
                                                <div><b>Campo magn√©tico elevado</b></div>
                                                <div>
                                                    Zonas de acceso restringido.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sign-item">
                                            <div class="sign-icon">L</div>
                                            <div>
                                                <div><b>Radiaci√≥n l√°ser</b></div>
                                                <div>
                                                    Zonas de acceso restringido. Peligro de quemadura de piel y ojos en
                                                    funci√≥n de la longitud de onda y la potencia del l√°ser.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="sign-item">
                                            <div class="sign-icon">C</div>
                                            <div>
                                                <div><b>L√≠quidos criog√©nicos</b></div>
                                                <div>
                                                    Riesgo de quemadura de piel y ojos, riesgo de desplazamiento de
                                                    ox√≠geno.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <h2 class="senyalizacion-title">En caso de emergencia</h2>
                                    <p>
                                        Le agradecemos su colaboraci√≥n siguiendo estas indicaciones:
                                    </p>

                                    <div>
                                        <div>
                                            <div class="emergency-item">
                                                <div class="emergency-icon">‚áÑ</div>
                                                <div>
                                                    <strong>Identif√≠quese</strong> al entrar y avise cuando abandone el
                                                    centro.
                                                </div>
                                            </div>

                                            <div class="emergency-item">
                                                <div class="emergency-icon">üë•</div>
                                                <div>
                                                    Considere a la persona que ha venido a visitar como la
                                                    <strong>responsable de ayudarle</strong> en caso de emergencia.
                                                </div>
                                            </div>

                                            <div class="emergency-item">
                                                <div class="emergency-icon">‚è∞</div>
                                                <div>
                                                    Si al sonar la alarma se encuentra solo, dir√≠jase al
                                                    <strong>punto de encuentro</strong> correspondiente.
                                                </div>
                                            </div>

                                            <div class="emergency-item">
                                                <div class="emergency-icon">!</div>
                                                <p>
                                                    En caso de detectar una situaci√≥n de emergencia
                                                    <strong>avise a su contacto en el centro</strong>.
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <br>
                                    <hr><br>
                                    <h2 class="senyalizacion-title">Tel√©fonos de emergencia</h2>
                                    <p><b style="color: red;">EMERGENCIA 112</b></p>
                                    <p><b>SEGURIDAD DEL CAMPUS</b> <br>93 581 25 25</p>
                                    <p><b>URGENCIAS MUTUA FREMAP</b> <br>900 61 00 61 (Espa√±a) <br>+ 34 91 919 61 61
                                        (Extranjero)
                                    </p>
                                    <p><b>INFORMACI√ìN TOXICOLOGICA</b> <br>91 562 04 20</p>
                                    <p><b>√ÅREA DE PREVENCI√ìN DE RIESGOS LABORALES</b> <br>91 568 19 25/81</p>
                                    <p><b>UNIDAD DE VIGILANCIA DE LA SALUD</b> <br>91 568 19 31/32/33</p>
                                    <p><b>SERVICIO DE PREVENCI√ìN DE BARCELONA</b> <br>93 442 6576</p>
                                </div>
                                <div class="col-4">
                                    <h2 class="senyalizacion-title">Puntos de encuentro</h2>

                                    <b>Esquema de situaci√≥n</b>
                                    <p>
                                        ‚Ä¢ Punto de encuentro ICMAB<br>
                                        ‚Ä¢ Punto de encuentro MATGAS<br>
                                        ‚Ä¢ Parque de Bomberos de Cerdanyola<br>
                                        ‚Ä¢ Campus UAB Bellaterra<br>
                                        ‚Ä¢ AP-7
                                    </p>
                                    <img src="puntos_encuentro.png" alt="Mapa de situaci√≥n" class="mb-3">

                                    <br><b>Zonas comunes</b>
                                    <p>
                                        ‚Ä¢ Cafeter√≠a ICMAB<br>
                                        ‚Ä¢ Cafeter√≠a MATGAS<br>
                                        ‚Ä¢ Salas de Reuniones<br>
                                        ‚Ä¢ Jard√≠n ICMAB<br>
                                        ‚Ä¢ Aseos
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bot√≥n QR flotante -->
        <div class="qr-section">
            <button class="qr-button" @click="showQR = true" title="Mostrar c√≥digo QR">
                <i class="bi bi-qr-code"></i>
            </button>
        </div>

        <!-- Bot√≥n de instalaci√≥n PWA m√≥vil (debajo del QR) -->
        <button v-if="isMobile && !isPWAInstalled" class="mobile-pwa-button" @click="installPWA"
            title="Instalar com a aplicaci√≥">
            <i class="bi bi-download"></i>Instal¬∑lar aplicaci√≥
        </button>



        <!-- Bot√≥n de instalaci√≥n PWA desktop (discreto) -->
        <div class="pwa-install-section" v-if="installButton && !isMobile"
            style="position: fixed; bottom: 20px; left: 20px; z-index: 1000;">
            <button class="btn" @click="installPWA" title="Instal¬∑lar com a aplicaci√≥">
                <i class="bi bi-download"></i>
            </button>
        </div>



        <!-- Modal QR -->
        <div class="modal fade" :class="{ show: showQR }" :style="{ display: showQR ? 'block' : 'none' }" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content qr-modal">
                    <div class="modal-header">
                        <h5 class="modal-title">Codi QR del Portal</h5>
                        <button type="button" class="btn-close" @click="closeQR"></button>
                    </div>
                    <div class="modal-body">
                        <div class="qr-code-container">
                            <div id="qr-code"></div>
                            <p class="mt-3 text-muted">
                                Escane√Ø aquest codi per accedir al portal des de el teu m√≤bil
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Backdrop del modal -->
        <div v-if="showQR" class="modal-backdrop fade show"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // Estado reactivo
                const activeTab = ref('directorio');
                const personal = ref([]);
                const departamentos = ref([]);
                const loading = ref(false);
                const error = ref(null);
                const searchQuery = ref('');
                const selectedDepartment = ref('');
                const viewMode = ref('grid');
                const showQR = ref(false);

                // Configuraci√≥n de pesta√±as
                const tabs = ref([
                    { id: 'directorio', title: 'Directori de personal', icon: 'bi bi-people' },
                    { id: 'emergencia', title: 'Enlla√ßos i contactes', icon: 'bi bi-telephone' }
                ]);

                // Computed properties
                const uniqueDepartments = computed(() => {
                    const depts = personal.value.map(p => p.department_name).filter(Boolean);
                    return [...new Set(depts)].sort();
                });

                const filteredPersonal = computed(() => {
                    let filtered = personal.value;

                    // Filtro por departamento
                    if (selectedDepartment.value) {
                        filtered = filtered.filter(p => p.department_name === selectedDepartment.value);
                    }

                    // Filtro por b√∫squeda
                    if (searchQuery.value) {
                        const query = searchQuery.value.toLowerCase();
                        filtered = filtered.filter(p => {
                            // Verificar que p existe y es un objeto v√°lido
                            if (!p || typeof p !== 'object') return false;

                            // Verificar cada campo individualmente para evitar errores con valores null
                            const cognomMatch = p.cognom && typeof p.cognom === 'string' && p.cognom.toLowerCase().includes(query);
                            const cognom2Match = p.cognom2 && typeof p.cognom2 === 'string' && p.cognom2.toLowerCase().includes(query);
                            const nomMatch = p.nom && typeof p.nom === 'string' && p.nom.toLowerCase().includes(query);
                            const usernameMatch = p.username && typeof p.username === 'string' && p.username.toLowerCase().includes(query);
                            const emailMatch = p.email && typeof p.email === 'string' && p.email.toLowerCase().includes(query);

                            return cognomMatch || cognom2Match || nomMatch || usernameMatch || emailMatch;
                        });
                    }

                    return filtered;
                });

                // M√©todos
                const loadPersonal = async () => {
                    loading.value = true;
                    error.value = null;

                    try {
                        const response = await fetch('api_personal.php');
                        const data = await response.json();

                        if (data.success) {
                            personal.value = data.data;
                        } else {
                            error.value = data.error || 'Error al carregar les dades';
                        }
                    } catch (err) {
                        error.value = 'Error de connexi√≥ amb el servidor';
                        console.error('Error:', err);
                    } finally {
                        loading.value = false;
                    }
                };

                const loadDepartamentos = async () => {
                    try {
                        const response = await fetch('api_departamentos.php');
                        const data = await response.json();

                        if (data.success) {
                            departamentos.value = data.data;
                        }
                    } catch (err) {
                        console.error('Error al carregar departaments:', err);
                    }
                };



                const hasValidContactValue = (value) => {
                    if (value === null || value === undefined) return false;
                    if (typeof value === 'string') {
                        const normalized = value.trim().toLowerCase();
                        return normalized !== '' && normalized !== 'null';
                    }
                    return true;
                };

                const formatContactValue = (value) => {
                    if (!hasValidContactValue(value)) return '';
                    return typeof value === 'string' ? value.trim() : value;
                };

                const highlightSearch = (text) => {
                    if (!searchQuery.value) return text;
                    const regex = new RegExp(`(${searchQuery.value})`, 'gi');
                    return text.replace(regex, '<span class="search-highlight">$1</span>');
                };

                const getInitials = (person) => {
                    let initials = '';
                    // Obtener primera letra del primer apellido
                    if (person.cognom && person.cognom.trim()) {
                        initials += person.cognom.trim().charAt(0).toUpperCase();
                    }
                    // Obtener primera letra del nombre
                    if (person.nom && person.nom.trim()) {
                        initials += person.nom.trim().charAt(0).toUpperCase();
                    }
                    // Si no hay iniciales, usar las primeras dos letras del username
                    if (!initials && person.username) {
                        initials = person.username.substring(0, 2).toUpperCase();
                    }
                    return initials || '??';
                };

                const generateInitialsAvatar = (person, size = 80) => {
                    const initials = getInitials(person);
                    // Usar siempre el azul primario
                    const bgColor = '#0345bf';

                    const svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg"><circle cx="${size / 2}" cy="${size / 2}" r="${size / 2}" fill="${bgColor}"/><text x="${size / 2}" y="${size / 2}" font-family="Arial, sans-serif" font-size="${size * 0.4}" font-weight="bold" fill="white" text-anchor="middle" dominant-baseline="central">${initials}</text></svg>`;

                    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
                };

                const handleImageError = (event, person) => {
                    if (person) {
                        // Obtener el tama√±o de la imagen desde los estilos
                        const width = event.target.offsetWidth || 80;
                        event.target.src = generateInitialsAvatar(person, width);
                    } else {
                        // Fallback si no hay informaci√≥n de persona
                        event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNlMGUwZTAiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOTk5OTk5Ij4KPHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPgo8L3N2Zz4KPC9zdmc+';
                    }
                };

                const generateQR = () => {
                    if (showQR.value) {
                        // Usar la URL actual donde est√° instalado el c√≥digo
                        const currentUrl = window.location.href;
                        const qrContainer = document.getElementById('qr-code');

                        console.log('Generando QR para:', currentUrl);
                        console.log('QR container encontrado:', qrContainer);

                        if (qrContainer) {
                            // Limpiar el contenedor antes de generar
                            qrContainer.innerHTML = '';

                            // Verificar que QRCode est√© disponible
                            if (typeof QRCode !== 'undefined') {
                                console.log('QRCode library disponible, generando...');

                                try {
                                    // Crear un nuevo QRCode instance
                                    const qr = new QRCode(qrContainer, {
                                        text: currentUrl,
                                        width: 200,
                                        height: 200,
                                        colorDark: '#0345bf',
                                        colorLight: '#ffffff',
                                        correctLevel: QRCode.CorrectLevel.H
                                    });

                                    console.log('QR generado exitosamente');
                                } catch (error) {
                                    console.error('Error generando QR:', error);
                                    qrContainer.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">Error generando QR</div>';
                                }
                            } else {
                                console.error('QRCode library no est√° disponible');
                                qrContainer.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">QRCode no disponible</div>';
                            }
                        } else {
                            console.error('QR container no encontrado');
                        }
                    }
                };

                const closeQR = () => {
                    showQR.value = false;
                };

                // Watchers
                watch(searchQuery, () => {
                    // No hacer nada aqu√≠, el filtrado se hace en el computed
                });

                watch(selectedDepartment, () => {
                    // No hacer nada aqu√≠, el filtrado se hace en el computed
                });

                watch(showQR, async (newVal) => {
                    if (newVal) {
                        console.log('Modal QR abierto, generando...');
                        // Esperar a que el DOM se actualice
                        await nextTick();
                        // Esperar un poco m√°s para asegurar que el modal est√© visible
                        setTimeout(() => {
                            console.log('Intentando generar QR...');
                            generateQR();
                        }, 300);
                        // Cerrar modal al hacer clic fuera
                        document.addEventListener('click', handleOutsideClick);
                    } else {
                        document.removeEventListener('click', handleOutsideClick);
                    }
                });

                const handleOutsideClick = (event) => {
                    if (event.target.classList.contains('modal-backdrop')) {
                        closeQR();
                    }
                };

                // PWA Installation
                let deferredPrompt;
                const installButton = ref(false);
                const isMobile = ref(false);
                const isPWAInstalled = ref(false);

                const installPWA = () => {
                    if (deferredPrompt) {
                        // Mostrar el prompt de instalaci√≥n
                        deferredPrompt.prompt();

                        // Esperar la respuesta del usuario
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                isPWAInstalled.value = true;
                                installButton.value = false;
                            }

                            // Limpiar el prompt
                            deferredPrompt = null;
                        }).catch((error) => {
                            console.error('Error durante la instalaci√≥n:', error);
                            deferredPrompt = null;
                        });
                    } else {
                        // Verificar si ya est√° instalada
                        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
                            isPWAInstalled.value = true;
                        } else {
                            // Mostrar instrucciones alternativas
                            alert('Para instalar la aplicaci√≥n:\n\nEn Chrome/Edge: Busca el bot√≥n de instalaci√≥n en la barra de direcciones\nEn Firefox: Busca el bot√≥n de instalaci√≥n en la barra de direcciones\nEn Safari: Usa "Compartir" > "A√±adir a pantalla de inicio"');
                        }
                    }
                };



                // Lifecycle
                onMounted(() => {
                    loadDepartamentos();
                    loadPersonal();

                    // Detectar si es m√≥vil
                    const checkMobile = () => {
                        isMobile.value = window.innerWidth <= 768;
                    };
                    checkMobile();
                    window.addEventListener('resize', checkMobile);

                    // Registrar Service Worker para PWA
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('./sw.js')
                            .then((registration) => {
                                console.log('Service Worker registrado correctamente');
                            })
                            .catch((error) => {
                                console.error('Error registrando Service Worker:', error);
                            });
                    }

                    // Escuchar evento de instalaci√≥n de PWA
                    window.addEventListener('beforeinstallprompt', (e) => {
                        // Prevenir el banner autom√°tico de instalaci√≥n
                        e.preventDefault();
                        deferredPrompt = e;

                        // Mostrar el bot√≥n apropiado seg√∫n el dispositivo
                        if (!isMobile.value) {
                            installButton.value = true;
                        }
                    });

                    // Escuchar cuando la PWA se instala
                    window.addEventListener('appinstalled', (e) => {
                        isPWAInstalled.value = true;
                        installButton.value = false;
                        deferredPrompt = null;
                    });



                    // Verificar si la PWA ya est√° instalada
                    const checkPWAInstalled = () => {
                        const isStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
                        const isInApp = window.navigator.standalone === true; // iOS

                        if (isStandalone || isInApp) {
                            isPWAInstalled.value = true;
                            installButton.value = false;
                        }
                    };

                    checkPWAInstalled();

                    // Verificar cambios en el modo de visualizaci√≥n
                    if (window.matchMedia) {
                        const mediaQuery = window.matchMedia('(display-mode: standalone)');
                        mediaQuery.addEventListener('change', checkPWAInstalled);
                    }
                });

                return {
                    activeTab,
                    personal,
                    departamentos,
                    loading,
                    error,
                    searchQuery,
                    selectedDepartment,
                    viewMode,
                    showQR,
                    tabs,
                    uniqueDepartments,
                    filteredPersonal,
                    loadPersonal,
                    loadDepartamentos,
                    highlightSearch,
                    hasValidContactValue,
                    formatContactValue,
                    handleImageError,
                    generateQR,
                    closeQR,
                    handleOutsideClick,
                    installPWA,
                    installButton,
                    isMobile,
                    isPWAInstalled
                };
            }
        }).mount('#app');
    </script>
</body>

</html>