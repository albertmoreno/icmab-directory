<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal de Información - ICMAB</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Fuente Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Reset básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            color: #333;
            line-height: 1.6;
        }

        header {
            background: #F5F7F9;
            border-bottom: 1px solid #e9ecef;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .portal-info h4 {
            color: #0345bf;
            font-weight: 600;
        }

        .portal-info p {
            font-size: 0.9em;
        }

        /* Control de visibilidad de logos */
        .logo-tablet {
            display: none;
        }

        /* Responsive para el header */
        @media (max-width: 1024px) {

            /* iPad vertical, tablets y móviles */
            .logo-desktop {
                display: none;
            }

            .logo-tablet {
                display: block;
                height: 60px !important;
                width: auto;
                max-width: 100%;
            }

            .portal-info {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .logo-tablet {
                height: 50px !important;
            }
        }

        main {
            min-height: calc(100vh - 100px);
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        h2 {
            color: #0345bf;
            margin-bottom: 20px;
        }

        /* Estilos para las pestañas */
        .nav-tabs {
            border-bottom: 2px solid #0345bf;
            margin-bottom: 0;
        }

        .nav-tabs .nav-link {
            color: #666;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: #0345bf;
            border-bottom: 3px solid #0345bf;
            background-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: #0345bf;
            background-color: transparent;
            border-bottom: 3px solid #0345bf;
        }

        .tab-content {
            padding: 20px 0;
        }

        .tab-pane {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .buscador {
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 8px;
            margin: 10px 0;
        }

        .persona {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            height: 100%;
        }

        .persona:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .persona .card-body {
            display: flex;
            align-items: flex-start;
            padding: 20px;
        }

        .persona .photo-section {
            flex-shrink: 0;
            margin-right: 20px;
        }

        .persona img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #0345bf;
        }

        .persona .info-section {
            flex: 1;
            text-align: left;
        }

        .persona .card-title {
            color: #0345bf;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .persona .department-name {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-style: italic;
        }

        .contact-info {
            margin-top: 10px;
        }

        .contact-info .contact-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.85em;
        }

        .contact-info .contact-item i {
            margin-right: 8px;
            color: #0345bf;
            width: 16px;
        }

        .contact-info .contact-item a {
            color: #0345bf;
            text-decoration: none;
        }

        .contact-info .contact-item a:hover {
            text-decoration: underline;
        }

        /* Responsive para móviles */
        @media (max-width: 768px) {
            .persona .card-body {
                flex-direction: column;
                text-align: center;
            }

            .persona .photo-section {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .persona .info-section {
                text-align: center;
            }
        }

        /* Emergencia */
        .emergencia .list-group-item {
            border-left: none;
            border-right: none;
        }

        .emergencia .list-group-item:first-child {
            border-top: none;
        }

        .emergencia .list-group-item:last-child {
            border-bottom: none;
        }

        .emergencia a {
            color: #0345bf;
            text-decoration: none;
        }

        .emergencia a:hover {
            text-decoration: underline;
        }

        /* QR Code */
        .qr-section {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .qr-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #0345bf;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .qr-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .qr-modal .modal-content {
            border-radius: 15px;
        }

        .qr-code-container {
            text-align: center;
            padding: 20px;
        }

        #qr-code {
            /*border: 1px solid #ddd;*/
            border-radius: 8px;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            min-height: 200px;
        }

        /* Mejoras adicionales */
        .search-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .view-toggle {
            margin-bottom: 20px;
        }

        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header class="text-center py-4">
            <div class="container">
                <div class="logo-section mb-3">
                    <img src="https://media.icmab.es/logos/icmab/BANNER-WEB-icmabcsic-2025.png" alt="Logo ICMAB"
                        height="80" class="mb-2 img-fluid logo-desktop">
                    <img src="https://media.icmab.es/logos/icmab/icmab-ochoa-color.svg" alt="Logo ICMAB" height="60"
                        class="mb-2 img-fluid logo-tablet">
                    <div class="portal-info">
                        <h4 class="mb-1 text-dark">Directori del personal</h4>
                        <p class="text-muted mb-0">Institut de Ciència de Materials de Barcelona</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenido principal -->
        <main>
            <!-- Pestañas de navegación -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation" v-for="tab in tabs" :key="tab.id">
                    <button class="nav-link" :class="{ active: activeTab === tab.id }" @click="activeTab = tab.id"
                        type="button" role="tab">
                        <i :class="tab.icon"></i> {{ tab.title }}
                    </button>
                </li>
            </ul>

            <!-- Contenido de las pestañas -->
            <div class="tab-content">
                <!-- Pestaña Directorio -->
                <div class="tab-pane fade" :class="{ 'show active': activeTab === 'directorio' }" role="tabpanel">
                    <div class="mt-4">
                        <h2><i class="bi bi-people"></i> Directori de personal</h2>

                        <!-- Estadísticas -->
                        <div class="stats" v-if="personal.length > 0">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <strong>{{ personal.length }}</strong><br>
                                    <small class="text-muted">Total</small>
                                </div>
                                <div class="col-md-4">
                                    <strong>{{ filteredPersonal.length }}</strong><br>
                                    <small class="text-muted">Mostrats</small>
                                </div>
                                <div class="col-md-4">
                                    <strong>{{ uniqueDepartments.length }}</strong><br>
                                    <small class="text-muted">Departaments</small>
                                </div>
                            </div>
                        </div>

                        <!-- Buscador -->
                        <div class="buscador">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" v-model="searchQuery"
                                            placeholder="Buscar por nom, cognom, email o usuari...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" v-model="selectedDepartment">
                                        <option value="">Tots els departaments</option>
                                        <option v-for="dept in uniqueDepartments" :key="dept" :value="dept">
                                            {{ dept }}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-primary"
                                            :class="{ active: viewMode === 'grid' }" @click="viewMode = 'grid'">
                                            <i class="bi bi-grid"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary"
                                            :class="{ active: viewMode === 'list' }" @click="viewMode = 'list'">
                                            <i class="bi bi-list"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de personal -->
                        <div v-if="loading" class="loading">
                            <i class="bi bi-arrow-clockwise spin"></i> Carregant personal...
                        </div>

                        <div v-else-if="error" class="error">
                            Error: {{ error }}
                        </div>

                        <div v-else-if="filteredPersonal.length === 0" class="loading">
                            No s'ha trobat cap resultat
                        </div>

                        <div v-else>
                            <!-- Vista de grilla -->
                            <div v-if="viewMode === 'grid'" class="row">
                                <div v-for="person in filteredPersonal" :key="person.id"
                                    class="col-lg-6 col-md-12 mb-3">
                                    <div class="card persona h-100">
                                        <div class="card-body">
                                            <div class="photo-section">
                                                <img :src="`https://media.icmab.es/staff/people/${person.username}.jpg`"
                                                    :alt="person.cognom" @error="handleImageError" class="mb-3">
                                            </div>
                                            <div class="info-section">
                                                <h5 class="card-title">
                                                    <span
                                                        v-html="highlightSearch(person.cognom + ' ' + (person.cognom2 || '') + ', ' + person.nom)"></span>
                                                </h5>
                                                <div v-if="person.department_name" class="department-name">
                                                    {{ person.department_name }}
                                                </div>
                                                <div class="contact-info">
                                                    <div v-if="person.telefon1" class="contact-item">
                                                        <i class="bi bi-telephone"></i> {{ person.telefon1 }}
                                                    </div>
                                                    <div v-if="person.email" class="contact-item">
                                                        <i class="bi bi-envelope"></i>
                                                        <a :href="`mailto:${person.email}`">{{ person.email }}</a>
                                                    </div>
                                                    <div v-if="person.despatx" class="contact-item">
                                                        <i class="bi bi-building"></i> {{ person.despatx }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vista de lista -->
                            <div v-else class="list-group">
                                <div v-for="person in filteredPersonal" :key="person.id"
                                    class="list-group-item list-group-item-action">
                                    <div class="d-flex align-items-center">
                                        <img :src="`https://media.icmab.es/staff/people/${person.username}.jpg`"
                                            :alt="person.cognom" @error="handleImageError" class="rounded-circle me-3"
                                            style="width: 50px; height: 50px; object-fit: cover;">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <span
                                                    v-html="highlightSearch(person.cognom + ' ' + (person.cognom2 || '') + ', ' + person.nom)"></span>
                                            </h6>
                                            <small v-if="person.department_name" class="text-muted">
                                                {{ person.department_name }}
                                            </small>
                                            <div class="contact-info mt-2">
                                                <div v-if="person.telefon1" class="contact-item">
                                                    <i class="bi bi-telephone"></i> {{ person.telefon1 }}
                                                </div>
                                                <div v-if="person.email" class="contact-item">
                                                    <i class="bi bi-envelope"></i> {{ person.email }}
                                                </div>
                                                <div v-if="person.despatx" class="contact-item">
                                                    <i class="bi bi-building"></i> {{ person.despatx }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pestaña Emergencia -->
                <div class="tab-pane fade" :class="{ 'show active': activeTab === 'emergencia' }" role="tabpanel">
                    <div class="mt-4">
                        <h2><i class="bi bi-telephone"></i> Enllaços i contactes d'emergència</h2>
                        <div class="list-group">
                            <div class="list-group-item">
                                <i class="bi bi-exclamation-triangle text-danger"></i>
                                <strong> Emergències: </strong> <a href="tel:112">112</a>
                            </div>
                            <div class="list-group-item">
                                <i class="bi bi-globe text-primary"></i>
                                <strong> Informació general de l'Institut: </strong>
                                <a href="https://www.icmab.es" target="_blank">Pàgina
                                    principal de l'Institut</a>
                            </div>
                            <div class="list-group-item">
                                <i class="bi bi-envelope text-primary"></i>
                                <strong> Contacte d'administració: </strong>
                                <a href="mailto:info@icmab.es">info@icmab.es</a>
                            </div>
                            <div class="list-group-item">
                                <i class="bi bi-envelope text-primary"></i>
                                <strong> Gender Equality and Diversity Committee (confidencial): </strong>
                                <a href="mailto:contact_equality@icmab.es">contact_equality@icmab.es</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Botón QR flotante -->
        <div class="qr-section">
            <button class="qr-button" @click="showQR = true" title="Mostrar código QR">
                <i class="bi bi-qr-code"></i>
            </button>
        </div>

        <!-- Modal QR -->
        <div class="modal fade" :class="{ show: showQR }" :style="{ display: showQR ? 'block' : 'none' }" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content qr-modal">
                    <div class="modal-header">
                        <h5 class="modal-title">Codi QR del Portal</h5>
                        <button type="button" class="btn-close" @click="closeQR"></button>
                    </div>
                    <div class="modal-body">
                        <div class="qr-code-container">
                            <div id="qr-code"></div>
                            <p class="mt-3 text-muted">
                                Escaneï aquest codi per accedir al portal des de el teu mòbil
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Backdrop del modal -->
        <div v-if="showQR" class="modal-backdrop fade show"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // Estado reactivo
                const activeTab = ref('directorio');
                const personal = ref([]);
                const departamentos = ref([]);
                const loading = ref(false);
                const error = ref(null);
                const searchQuery = ref('');
                const selectedDepartment = ref('');
                const viewMode = ref('grid');
                const showQR = ref(false);

                // Configuración de pestañas
                const tabs = ref([
                    { id: 'directorio', title: 'Directori de personal', icon: 'bi bi-people' },
                    { id: 'emergencia', title: 'Enllaços i contactes', icon: 'bi bi-telephone' }
                ]);

                // Computed properties
                const uniqueDepartments = computed(() => {
                    const depts = personal.value.map(p => p.department_name).filter(Boolean);
                    return [...new Set(depts)].sort();
                });

                const filteredPersonal = computed(() => {
                    let filtered = personal.value;

                    // Filtro por departamento
                    if (selectedDepartment.value) {
                        filtered = filtered.filter(p => p.department_name === selectedDepartment.value);
                    }

                    // Filtro por búsqueda
                    if (searchQuery.value) {
                        const query = searchQuery.value.toLowerCase();
                        filtered = filtered.filter(p =>
                            p.cognom.toLowerCase().includes(query) ||
                            p.cognom2.toLowerCase().includes(query) ||
                            p.nom.toLowerCase().includes(query) ||
                            p.username.toLowerCase().includes(query) ||
                            (p.email && p.email.toLowerCase().includes(query))
                        );
                    }

                    return filtered;
                });

                // Métodos
                const loadPersonal = async () => {
                    loading.value = true;
                    error.value = null;

                    try {
                        const params = new URLSearchParams();
                        if (searchQuery.value) params.append('busqueda', searchQuery.value);
                        if (selectedDepartment.value) params.append('departamento', selectedDepartment.value);

                        const response = await fetch(`api_personal.php?${params.toString()}`);
                        const data = await response.json();

                        if (data.success) {
                            personal.value = data.data;
                        } else {
                            error.value = data.error || 'Error al carregar les dades';
                        }
                    } catch (err) {
                        error.value = 'Error de connexió amb el servidor';
                        console.error('Error:', err);
                    } finally {
                        loading.value = false;
                    }
                };

                const loadDepartamentos = async () => {
                    try {
                        const response = await fetch('api_departamentos.php');
                        const data = await response.json();

                        if (data.success) {
                            departamentos.value = data.data;
                        }
                    } catch (err) {
                        console.error('Error al carregar departaments:', err);
                    }
                };

                const highlightSearch = (text) => {
                    if (!searchQuery.value) return text;
                    const regex = new RegExp(`(${searchQuery.value})`, 'gi');
                    return text.replace(regex, '<span class="search-highlight">$1</span>');
                };

                const handleImageError = (event) => {
                    event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNlMGUwZTAiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOTk5OTk5Ij4KPHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPgo8L3N2Zz4KPC9zdmc+';
                };

                const generateQR = () => {
                    if (showQR.value) {
                        // Usar una URL de prueba más simple
                        const testUrl = 'https://www.icmab.es';
                        const qrContainer = document.getElementById('qr-code');

                        console.log('Generando QR para:', testUrl);
                        console.log('QR container encontrado:', qrContainer);

                        if (qrContainer) {
                            // Limpiar el contenedor antes de generar
                            qrContainer.innerHTML = '';

                            // Verificar que QRCode esté disponible
                            if (typeof QRCode !== 'undefined') {
                                console.log('QRCode library disponible, generando...');

                                try {
                                    // Crear un nuevo QRCode instance
                                    const qr = new QRCode(qrContainer, {
                                        text: testUrl,
                                        width: 200,
                                        height: 200,
                                        colorDark: '#0345bf',
                                        colorLight: '#ffffff',
                                        correctLevel: QRCode.CorrectLevel.H
                                    });

                                    console.log('QR generado exitosamente');
                                } catch (error) {
                                    console.error('Error generando QR:', error);
                                    qrContainer.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">Error generando QR</div>';
                                }
                            } else {
                                console.error('QRCode library no está disponible');
                                qrContainer.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">QRCode no disponible</div>';
                            }
                        } else {
                            console.error('QR container no encontrado');
                        }
                    }
                };

                const closeQR = () => {
                    showQR.value = false;
                };

                // Watchers
                watch(searchQuery, () => {
                    loadPersonal();
                });

                watch(selectedDepartment, () => {
                    loadPersonal();
                });

                watch(showQR, async (newVal) => {
                    if (newVal) {
                        console.log('Modal QR abierto, generando...');
                        // Esperar a que el DOM se actualice
                        await nextTick();
                        // Esperar un poco más para asegurar que el modal esté visible
                        setTimeout(() => {
                            console.log('Intentando generar QR...');
                            generateQR();
                        }, 300);
                        // Cerrar modal al hacer clic fuera
                        document.addEventListener('click', handleOutsideClick);
                    } else {
                        document.removeEventListener('click', handleOutsideClick);
                    }
                });

                const handleOutsideClick = (event) => {
                    if (event.target.classList.contains('modal-backdrop')) {
                        closeQR();
                    }
                };

                // Lifecycle
                onMounted(() => {
                    loadDepartamentos();
                    loadPersonal();

                    // Verificar que QRCode esté disponible
                    setTimeout(() => {
                        console.log('Verificando QRCode library...');
                        if (typeof QRCode !== 'undefined') {
                            console.log('✅ QRCode library cargada correctamente');
                        } else {
                            console.error('❌ QRCode library no está disponible');
                        }
                    }, 1000);
                });

                return {
                    activeTab,
                    personal,
                    departamentos,
                    loading,
                    error,
                    searchQuery,
                    selectedDepartment,
                    viewMode,
                    showQR,
                    tabs,
                    uniqueDepartments,
                    filteredPersonal,
                    loadPersonal,
                    loadDepartamentos,
                    highlightSearch,
                    handleImageError,
                    generateQR,
                    closeQR,
                    handleOutsideClick
                };
            }
        }).mount('#app');
    </script>
</body>

</html>